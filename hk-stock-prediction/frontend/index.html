<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¯ GongGu æ¸¯è‚¡AIé æ¸¬ç³»çµ±</title>
  <meta name="description" content="GongGu - AI-powered Hong Kong stock prediction system">
  
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #fff; min-height: 100vh; }
    header { background: #161b22; padding: 20px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, #3fb950, #58a6ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-actions { display: flex; gap: 10px; }
    .btn { padding: 8px 16px; border-radius: 6px; border: 1px solid #30363d; background: #21262d; color: #fff; cursor: pointer; font-size: 0.9rem; }
    .btn:hover { background: #30363d; }
    .btn-refresh { background: #238636; border-color: #238636; }
    .btn-refresh:hover { background: #2ea043; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; text-align: center; }
    .stat-value { font-size: 2rem; font-weight: 700; }
    .stat-value.buy { color: #3fb950; }
    .stat-value.sell { color: #f85149; }
    .stat-label { color: #8b949e; font-size: 0.9rem; margin-top: 4px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; border-radius: 8px; border: 1px solid #30363d; background: #161b22; color: #8b949e; cursor: pointer; }
    .tab.active { background: #3fb950; color: #000; border-color: #3fb950; }
    .stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .stock-card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .stock-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .stock-card.buy { border-left: 4px solid #3fb950; }
    .stock-card.sell { border-left: 4px solid #f85149; }
    .stock-card.hold { border-left: 4px solid #8b949e; }
    .stock-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .stock-symbol { font-size: 1.3rem; font-weight: 700; }
    .stock-name { color: #8b949e; font-size: 0.85rem; margin-top: 2px; }
    .stock-signal { padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; }
    .stock-signal.buy { background: #3fb950; color: #000; }
    .stock-signal.sell { background: #f85149; color: #fff; }
    .stock-signal.hold { background: #30363d; color: #8b949e; }
    .stock-price { font-size: 1.5rem; font-weight: 600; margin: 12px 0 8px; }
    .positive { color: #3fb950; }
    .negative { color: #f85149; }
    .indicators { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .indicator { background: #21262d; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; color: #8b949e; }
    .loading { text-align: center; padding: 60px; color: #8b949e; }
    footer { text-align: center; padding: 40px; color: #8b949e; border-top: 1px solid #30363d; margin-top: 40px; }

    /* Chart Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; }
    .modal-overlay.active { display: flex; align-items: center; justify-content: center; }
    .modal { background: #161b22; border-radius: 12px; width: 90%; max-width: 1000px; max-height: 90vh; overflow: hidden; }
    .modal-header { padding: 16px 20px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 1.2rem; font-weight: 600; }
    .modal-close { background: none; border: none; color: #8b949e; font-size: 1.5rem; cursor: pointer; padding: 4px 8px; }
    .modal-close:hover { color: #fff; }
    .modal-body { padding: 0; }
    #chartContainer { width: 100%; height: 500px; }
    .chart-loading { text-align: center; padding: 60px; color: #8b949e; }
  </style>
</head>
<body>
  <header>
    <div class="logo">ğŸ¯ GongGu</div>
    <div class="header-actions">
      <button class="btn btn-refresh" onclick="refreshData()">ğŸ”„ æ›´æ–°æ•¸æ“š</button>
    </div>
  </header>

  <main class="container">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalStocks">-</div>
        <div class="stat-label">è‚¡ç¥¨æ•¸é‡</div>
      </div>
      <div class="stat-card">
        <div class="stat-value buy" id="buyCount">-</div>
        <div class="stat-label">è²·å…¥ä¿¡è™Ÿ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value sell" id="sellCount">-</div>
        <div class="stat-label">è³£å‡ºä¿¡è™Ÿ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="lastUpdate">-</div>
        <div class="stat-label">æœ€å¾Œæ›´æ–°</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-filter="all">å…¨éƒ¨</button>
      <button class="tab" data-filter="buy">ğŸ“ˆ è²·å…¥</button>
      <button class="tab" data-filter="sell">ğŸ“‰ è³£å‡º</button>
      <button class="tab" data-filter="hold">âšª è§€æœ›</button>
    </div>

    <div class="stock-grid" id="stockList">
      <div class="loading">è¼‰å…¥ä¸­...</div>
    </div>
  </main>

  <footer>
    <p>ğŸš€ Powered by AI + Machine Learning</p>
  </footer>

  <!-- Chart Modal -->
  <div class="modal-overlay" id="chartModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="chartTitle">è‚¡ç¥¨åœ–è¡¨</div>
        <button class="modal-close" onclick="closeChart()">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="chartContainer">
          <div class="chart-loading">è¼‰å…¥åœ–è¡¨...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Use localhost for development, api.gonggu.app for production
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
      ? 'http://localhost:3000/api' 
      : 'https://api.gonggu.app/api';
    
    let allStocks = [];
    let chartWidget = null;

    async function loadData() {
      try {
        const response = await fetch(API_URL + '/stocks');
        const data = await response.json();
        
        allStocks = data.all_stocks || [];
        const buyStocks = allStocks.filter(s => s.signal === 'BUY');
        const sellStocks = allStocks.filter(s => s.signal === 'SELL');
        const holdStocks = allStocks.filter(s => s.signal === 'HOLD');
        const mlBuyStocks = allStocks.filter(s => s.ml_prediction === 'BUY');
        const mlSellStocks = allStocks.filter(s => s.ml_prediction === 'SELL');
        
        document.getElementById('totalStocks').textContent = data.total_stocks || 0;
        document.getElementById('buyCount').textContent = buyStocks.length + ' (ML:' + mlBuyStocks.length + ')';
        document.getElementById('sellCount').textContent = sellStocks.length + ' (ML:' + mlSellStocks.length + ')';
        document.getElementById('holdCount').textContent = holdStocks.length;
        
        // Show last update time
        const now = new Date();
        document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit' });
        
        renderStocks(allStocks);
        
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('stockList').innerHTML = '<div class="loading">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
      }
    }

    async function refreshData() {
      const btn = document.querySelector('.btn-refresh');
      btn.disabled = true;
      btn.textContent = 'æ›´æ–°ä¸­...';
      
      try {
        const response = await fetch(API_URL + '/fetch', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
          await loadData();
          btn.textContent = 'âœ… æ›´æ–°æˆåŠŸ';
        } else {
          btn.textContent = 'âŒ æ›´æ–°å¤±æ•—';
        }
      } catch (error) {
        btn.textContent = 'âŒ æ›´æ–°å¤±æ•—';
      }
      
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = 'ğŸ”„ æ›´æ–°æ•¸æ“š';
      }, 2000);
    }

    function renderStocks(stocks) {
      const grid = document.getElementById('stockList');
      
      if (stocks.length === 0) {
        grid.innerHTML = '<div class="loading">æš«ç„¡æ•¸æ“š</div>';
        return;
      }
      
      grid.innerHTML = stocks.map(stock => {
        const signalClass = stock.signal === 'BUY' ? 'buy' : (stock.signal === 'SELL' ? 'sell' : 'hold');
        const change = parseFloat(stock.change) || 0;
        const changeClass = change >= 0 ? 'positive' : 'negative';
        const changeSign = change >= 0 ? '+' : '';
        
        return '<div class="stock-card ' + signalClass + '" onclick="showChart(\'' + stock.symbol + '\', \'' + stock.name + '\')">' +
          '<div class="stock-header">' +
            '<div>' +
              '<div class="stock-symbol">' + stock.symbol + '</div>' +
              '<div class="stock-name">' + stock.name + '</div>' +
            '</div>' +
            '<div class="stock-signal ' + signalClass + '">' + stock.signal + '</div>' +
          '</div>' +
          '<div class="stock-price">$' + stock.close + ' <span class="' + changeClass + '">' + changeSign + stock.change + '%</span></div>' +
          '<div class="indicators">' +
            '<div class="indicator">RSI: ' + (stock.rsi14 || '-') + '</div>' +
            '<div class="indicator">MA20: $' + (stock.ma20 || '-') + '</div>' +
            (stock.ml_prediction ? '<div class="indicator" style="background:' + (stock.ml_prediction === 'BUY' ? '#238636' : '#da3633') + '">ğŸ¤– ' + stock.ml_prediction + ' ' + Math.round(stock.ml_confidence || 0) + '%</div>' : '') +
          '</div>' +
        '</div>';
      }).join('');
    }

    function showChart(symbol, name) {
      document.getElementById('chartModal').classList.add('active');
      document.getElementById('chartTitle').textContent = symbol + ' ' + name + ' - æŠ€è¡“åœ–è¡¨';
      
      const container = document.getElementById('chartContainer');
      container.innerHTML = '<div class="chart-loading">è¼‰å…¥åœ–è¡¨...</div>';
      
      // Create TradingView chart
      if (chartWidget) {
        chartWidget.remove();
      }
      
      chartWidget = new TradingView.widget({
        width: container.clientWidth,
        height: 500,
        symbol: "HKEX:" + symbol,
        interval: "D",
        timezone: "Asia/Hong_Kong",
        theme: "dark",
        style: "1",
        locale: "zh_HK",
        toolbar_bg: "#0d1117",
        enable_publishing: false,
        hide_top_toolbar: false,
        hide_legend: false,
        save_image: false,
        container_id: "chartContainer",
        backgroundColor: "#0d1117",
        gridColor: "#1e2228"
      });
      
      // Resize chart on modal resize
      setTimeout(() => {
        if (chartWidget && chartWidget.chart) {
          chartWidget.chart().resize(container.clientWidth, 500);
        }
      }, 1000);
    }

    function closeChart() {
      document.getElementById('chartModal').classList.remove('active');
      if (chartWidget) {
        chartWidget.remove();
        chartWidget = null;
      }
    }

    // Close modal on overlay click
    document.getElementById('chartModal').addEventListener('click', (e) => {
      if (e.target.id === 'chartModal') {
        closeChart();
      }
    });

    // Tab filtering
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const filter = tab.dataset.filter;
        if (filter === 'all') {
          renderStocks(allStocks);
        } else {
          renderStocks(allStocks.filter(s => s.signal === filter.toUpperCase()));
        }
      });
    });

    // Auto-refresh every 5 minutes
    loadData();
    setInterval(loadData, 5 * 60 * 1000);
  </script>
</body>
</html>
